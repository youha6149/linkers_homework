## 基本設計

### シーケンス図
![シーケンス図](./シーケンス図.png)

### 詳細
本システムは以下のような方針で設計されています。

### 1. ユーザー操作の簡略化を重視した設計

- **エントリーポイントの統合**:  
  `main.py`にユーザーが行う操作を集約し、コマンドライン引数で動作を切り替えられるようにすることで、ユーザーが複数のスクリプトを実行する手間を省いています。たとえば、`--search-only`オプションを使用することで、インデックス作成をスキップして検索のみを実行できるようにしています。これにより、ユーザーは一つのスクリプトで全ての操作を完了させることが可能です。

- **インタラクティブな入力プロンプト**:  
  検索機能において、ユーザーはコマンドライン上で直接クエリを入力する形式になっており、操作が直感的で簡単です。ユーザーが迷うことなく操作できるように設計されています。

- **実行ファイルによるシステムの実行**

### 2. シンプルな設計

- **モジュールの明確な分割**:  
  システムは、`indexing`、`utils`、`log`といったモジュールに明確に分割されています。それぞれのモジュールが特定の機能を担当しており、コードの責務が明確です。これにより、コードの理解と保守が容易になっています。

- **統一された操作ロジック**:  
  インデックス作成や検索といった主要な機能が一貫したロジックで実装されており、コード全体がシンプルかつ直感的です。特に、`InvertedIndexManager`クラスが転置インデックスの作成・保存・検索の全てを管理することで、機能間の一貫性が保たれています。

### 3. テストを意識した設計

- **汎用的なデータ形式の採用**:
  `utils/csv_loader.py`において、CSVデータを`list[dict]`形式に変換しているため、データの取り扱いが非常に汎用的です。これにより、単体テストやモックを利用したテストが容易に行え、テストの信頼性が高まります。

- **シングルトンパターンの採用**:
  `LoggerSetup`クラスにシングルトンパターンを採用しており、全てのテストや実行環境で一貫したロギング設定を使用できます。このため、ログ関連のテストが単純かつ一貫性を保って行われるように設計されています。

- **処理の分離**:
  ダウンロード、データロード、インデックスの作成・検索といった処理がそれぞれ独立しているため、個別にテストを行うことが可能です。特に、`CsvDownloader`や`Tokenizer`のようなクラスは、その機能が明確であり、単体テストに向いています。

---

## 詳細設計

### main.py

- **本システムのエントリーポイント**
  - コマンドライン引数に応じて以下のいずれかを実行します
     1. 検索のみ(`--search-only`)
     2. 対象CSVのダウンロード + 転置インデックスの作成 + 検索

- **詳細**
  1. **検索操作のみ**
  2. **検索操作 + CSV入力操作**
  - ユーザーが行う操作が上記2通り考えられ、簡便さを重視し、専用のエントリーポイントを用意せずに、`main.py`に処理を集約しました。引数で動作を指定できるようにすることで、操作性を向上させています。

---

### indexing/entry.py

- **ユーザーの操作に応じて、転置インデックスの作成と検索を呼び出すためのモジュール**

#### create_inverted_index

- **概要**
  - CSVファイル（`csv_file_path`）を読み込み、転置インデックスを作成します。
  - 作成したインデックスは指定されたファイル（`inverted_index_file`）に保存されます。
  - **主な手順**:
    1. 全国.jpのCSVをダウンロード
    2. `load_csv`関数を使ってCSVデータをロード
    3. インデックスを構築（`build`メソッド）
    4. インデックスをPKLファイルに保存（`save`メソッド）

- **詳細**
  - CSVの読み込みを同期的に行っています。非同期処理との比較検討の結果、実行速度に大きな差がなかったため、保守性とコードの簡潔さを考慮して同期的な処理を採用しています（詳細は[転置インデックス作成を非同期的に行った場合の検証](#転置インデックス作成を非同期的に行った場合の検証)を参照）。

#### search_inverted_index

- **概要**
  - 保存された転置インデックスをロードし、ユーザーが入力したクエリに基づいて検索を行います。
  
- **詳細**
  - 検索操作を分かりやすくするため、クエリ入力のコードを関数内に含めています。これは、ユーザーがスムーズに操作できるようにするためです。
  - **主な手順**:
    1. ユーザーから検索クエリを入力
    2. 転置インデックスデータをロード
    3. ロードしたインデックスからクエリに一致する行を検索（`search`メソッド）
    4. 結果を表示

---

### indexing/indexing/InvertedIndexManager

- **転置インデックスの構築から検索処理までを担当するクラス**

#### __init__

- **概要**
  - 転置インデックスの初期化を行います。初期化時に既存のインデックスをロードすることはありません。

#### build

- **概要**
  - リスト形式の辞書（list[dict]）に変換されたCSVデータを元に、転置インデックスを作成します。

- **詳細**
  - 正規化→分割の流れを採用し、タームリストと検索値の一貫性を確保しています。
  - ポスティングリストのデータを行番号ではなく出力対象項目データにしたのは、CSVから対象行を探すオーバーヘッドを防ぐためです。
  - 単一の項目値（例：曙、北、東など）は、それ自体が検索値として現れることを想定し、別途パディングを施して単一文字列の検索にも対応しています。
  - `Tokenizer`クラスを用いて住所や地名をトークンに分割し、それをキーとしてインデックスを構築します。
  - 具体的には、住所を構成する要素（都道府県、市区町村、町域など）を結合してインデックスを作成します。

#### save

- **概要**
  - 転置インデックスを指定されたファイルパスに保存します。pickleを使ってオブジェクトをシリアライズ化し、ファイルに書き込みます。

- **詳細**
  - インデックスファイルのデータサイズが大きくなったため、またユーザーが直接インデックスを確認する必要がないと考え、シリアライズ化して保存しています。

#### load

- **概要**
  - 指定されたファイルから転置インデックスをロードします。pickleを使ってファイルからオブジェクトをデシリアライズ化します。

#### search

- **概要**
  - クエリに基づいてインデックスを検索します。クエリに含まれるトークンがインデックス内で一致するものをすべて取得し、その結果をリスト形式で返します。

- **詳細**
  - クエリの正規化処理を行います。
  - 現状では「大阪市梅田」のような市区町村が抜けたクエリの場合、検索結果が0件になる可能性があります。
    - **改善案**: 転置インデックスファイルに連続していない項目の接頭・末尾の文字列を使ったトークンを作成し、タームリストとして採用することを検討。
  - **手順**:
    1. 検索値を正規化したトークンに変換
    2. 転置インデックスから同名のキーを検索
    3. トークンが複数ある場合、重複する項目行のみを取得

---

### utils/csv_downloader/CsvDownloader

- **指定されたURLからZIP形式のCSVデータをダウンロードし、その内容をローカルに解凍・保存するクラス**

#### __init__

- **詳細**
  - `download`と`extract`の処理を分割するために`zip_content`をコンストラクタで定義しています。

#### download

- **概要**
  - 指定されたURLからZIPファイルをダウンロードし、その内容をバイト列として`zip_content`に保存します。

#### extract

- **概要**
  - ダウンロードしたZIPファイルを解凍し、指定されたディレクトリにCSVファイルを保存します。

---

### utils/csv_loader

- **全国.jpのCSVデータをlist[dict]型に変換して出力するモジュール**
  - 本モジュールを用いて、汎用的なデータ型であるlist[dict]形式のデータを受け渡しできるようにし、テスト効率を向上させています。

#### load_csv

- **概要**
  - 指定されたCSVファイルを読み込み、リスト形式（各行が辞書として格納される）で返す関数です。

- **詳細**
  - 処理速度を考慮し、`DictReader`を使用していますが、リスト形式に変換してもオーバーヘッドが発生しなかったため、テスト適正の高い本関数を採用しました。
  - **処理の流れ**:
    1. 指定されたパスからCSVファイルを開きます。
    2. `csv.DictReader`を使用して、各行を辞書として読み込みます。
    3. すべての行をリストに格納して返します。

---

### utils/tokenizer/Tokenizer

- **トークンの作成と正規化を行うためのクラス**
   - 転置インデックスの作成と検索の両機能で本クラスを使用し、検索値とタームリストの一貫性を確保します。

#### create_2gram

- **概要**
  - 入力された文字列をトークンに分割します。

- **例**
  - "東京都" → ["東京", "京都"]
  - "東京" → ["東京"]
  - "東" → ["_東", "東_"]

- **詳細**
  - 文字列が1文字の場合（例：曙、甲、境など）でも検索に対応できるよう、文字列の前後に"_"を付けてからトークンに変換しています。

#### normalize_key

- **概要**
  - 文字列を全角大文字に変換し、全角空白をアスタリスク（*）に置き換えます。

- **詳細**
  - アスタリスクに置き換えるのは、単一の項目値（例：曙、東、北など）と区別するためです。
  - トークンとタームリストの双方を大文字・全角で正規化することで、検索結果の一貫性を確保しています。
  - 標準ライブラリを用いて全角に統一しようとした場合、カスタムマッピングを利用する必要があり、エラーのリスクが高まるため外部ライブラリを採用しました。
  - 以下の2つのライブラリを比較し、Snykでのスコアとスター数から`jaconv`を採用しました（2024/08/26現在）。
    - `jaconv`
      - [GitHub](https://github.com/ikegami-yukino/jaconv): 300 stars
      - [Snyk](https://snyk.io/advisor/python/jaconv)
    - `mojimoji`
      - [GitHub](https://github.com/studio-ousia/mojimoji): 142 stars
      - [Snyk](https://snyk.io/advisor/python/mojimoji)

---

### log/logger/LoggerSetup

- **ログ管理クラス**
   - 全エラーを継続不可にすることで、予期しない挙動を防ぐ
   - ユーザーに表示するエラーをシンプルにすることで、ユーザーに配慮(実行ファイルを渡す都合上、ユーザーが自らエラー修正を行うことは想定していません。)

#### __new__

- **概要**
  - シングルトンパターンの導入

- **詳細**
  - クラスのインスタンスが既に存在するかどうかを確認し、存在しない場合にのみ新しいインスタンスを作成します。これにより、アプリケーション全体で一貫したロガー設定が提供されます。

#### _initialize

- **概要**
  - ロガーの初期設定を行います。

- **詳細**
  - DEBUGレベル以上のすべてのログが処理され、ログはファイルに保存されます。

#### get_logger

- **概要**
  - 設定したロガーを返すメソッド

- **詳細**
  - アプリケーション内の任意の場所で同じロガーを使用することができます。

---

## 開発の流れ

### **1~3日目まで**

#### 設計プランを比較検討

1. 事前作成しないプラン
   1. ユーザーにcsvを保存してもらう
   2. インデックス構築用スクリプトを実行
   3. 検索用スクリプトを実行
   4. 検索値を入力
   5. 検索結果を表示

2. requests取得プラン
   1. 検索スクリプトを実行
   2. csvがない場合、requestsでcsv取得
   3. 転置インデックスファイルを作成
   4. 検索値を入力
   5. 検索結果を表示

3. 事前作成するプラン
   1. 検索スクリプトを実行
   2. 検索値を入力
   3. 事前に保存された転置インデックスファイルを検索
   4. 検索結果を表示

| プラン  | csv入力操作有無 | 事前ファイル定義有無 | 工数 |
| ------- | :---------------: | :----------------: | :----: |
| プラン1 | ⚪︎              | ✖︎               | 多   |
| プラン2 | ✖︎              | ✖︎               | 中   |
| プラン3 | ✖︎              | ⚪︎               | 少   |

- 1,2はcsv入力用インターフェースが必要であり、工数が多くなる
- 2はcsv入力前提だが、ユーザー操作を少なくするためのプランとして考えていた

よって、最初の時点で工数が少なかったプラン3をベースにすることを決定
また、作成と検索をそれぞれ単一で実行できるようにすることで、転置インデックスファイルを事前に作成してはいけない場合でもすぐに切り替えられるように開発を進めた。

### 4日目

#### **CSV取得処理と実行ファイルの作成**

不明点に対していただいた回答:
>  1. 転置インデックスデータをソースコードに含めるべきなのか？
>
>     → 検索を高速化するために作る転置インデックスファイルそれ自体はgitへのコミット等を行わず、提出物にも含めないでください。
>  2. スクリプトを読み込ませて実行する方式でも良いとのことですが、その場合、実行環境にプログラミング言語の環境が整っていない可能性を考慮し、環境構築の手順も実行手順に含めるべきでしょうか？
>
>     → はい、環境構築の手順もご記載ください。

上記回答を元に転置インデックスファイルの作成をユーザー操作に含める形に変更を行った。

しかし、csvを入力してもらうのではなく、requestsによってcsvファイルを取得する方が、ユーザー入力の手間が少ないと考え、requestsによるデータ取得機能を追加することにした。

また、開発を進める中で、コンソールアプリケーションとして実装することで環境構築手順が省力化でき、ユーザー入力の手間をさらに減らせると考え、pyinstallerを用いて実行ファイルを作成した。

### **5日目~最終日** 

#### 環境別の実行ファイルのテストと各種ドキュメントの作成

以下のOS環境でpyinstallerを実行し、実行ファイルが実行できるかテストを行いました。
1. mac
   - m1 macbookair
2. windows
   - windows11
3. ubuntu
   - dockerにて仮想環境を構築(dockerfile参照)

---
### 検証

#### 転置インデックス作成を非同期的に行なった場合の検証

---

## 要件定義
### 1. **プログラムの機能要件**
   - **住所検索機能**: ユーザーが特定の単語を入力すると、その単語に一致する住所をリストとして返すプログラムを作成すること。
   - **高速な検索**: 高速な検索を実現するために、**転置インデックス**（Inverted Index）を使用して検索機能を実装する。
   - **N-gramの使用**: トークン分割（単語分割）アルゴリズムとして、**トークン**（N=2）を使用すること。

### 2. **入力データ要件**
   - **住所データ**: 住所データとして「住所.jp」の「全国」のCSVファイルを使用する。ファイルには、都道府県、市区町村、町域などの情報が含まれている。
   - **ファイルの取り扱い**: 住所データのCSVファイルをGitリポジトリにコミットしないようにする。

### 3. **検索の仕様**
   - **検索対象**: 入力文字列からトークンで作成される全てのトークンが、単一行の検索対象項目内に含まれる住所を検索結果として表示すること。
   - **検索項目**: 検索対象項目として、郵便番号以外の項目（都道府県、市区町村、町域、京都通り名、字丁目、事業所名、事業所住所）を使用すること。
   - **出力形式**: 検索結果には、「郵便番号」「都道府県」「市区町村」「町域」「京都通り名」「字丁目」「事業所名」「事業所住所」を表示すること。

### 4. **開発要件**
   - **プログラミング言語**: 開発言語に関する制限はない。
   - **実行方法**: スクリプトを直接読み込んで実行する形式（例：`python script.py`）または、コンソールアプリケーション、WEBアプリケーションとして実装しても良い。

### 5. **提出要件**
   - **提出物**: 開発したプログラムのソースコード、実行説明資料、技術説明資料をGitHubリポジトリへのリンクまたはZipファイルとして提出すること。
   - **実行説明資料**: プログラムの動作に必要な情報や手順を記述したドキュメントを含めること。
   - **技術説明資料**: コードの設計や、なぜその設計にしたかを説明したドキュメントを含めること。

### 6. **その他の要件**
   - **転置インデックスの利用**: プログラムは転置インデックスをファイルとして作成し、それに基づいて検索を行う形式で実装すること。
   - **スケーラビリティ**: 全国.jpデータの性質上、短期間に急激に増加することはないと考えられるため、シンプルな実装をすること。

